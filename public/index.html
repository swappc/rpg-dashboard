<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
        integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="./scripts/DeckPlayer.js"></script>
    <script src="./scripts/PlaylistPlayer.js"></script>
    <script src="./scripts/Key.js"></script>
    <script src="./scripts/LaunchpadController.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
        integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <title>RPG Audio Dashboard</title>
</head>

<body>
    <div style="text-align:center;border:3px solid #007bff">
        <h1>RPG Dashboard</h1>
    </div>
    <div class="row">
        <div class="col-2">
            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <a class="nav-link active" id="v-pills-dash-tab" data-toggle="pill" href="#v-pills-dash" role="tab"
                    aria-controls="v-pills-dash" aria-selected="true">Dashboard</a>
                <a class="nav-link" id="v-pills-playist-tab" data-toggle="pill" href="#v-pills-playist" role="tab"
                    aria-controls="v-pills-playist" aria-selected="false">Playist Manager</a>
                <a class="nav-link" id="v-pills-samplers-tab" data-toggle="pill" href="#v-pills-samplers" role="tab"
                    aria-controls="v-pills-samplers" aria-selected="false">Sampler Manager</a>

            </div>
        </div>
        <div class="col-10">
            <div class="tab-content" id="v-pills-tabContent">
                <div class="tab-pane fade show active" id="v-pills-dash" role="tabpanel"
                    aria-labelledby="v-pills-dash-tab">
                    <div class="container">
                        <div class="row">
                            <div class="col">
                                Playlist:
                                <label id="currentPlaylistLabel"></label>
                            </div>
                            <div class="col">
                                Now playing:
                                <label id="nowPlayingLabel"></label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-8">
                                <button class="btn btn-default" id="prevTrackButton" onclick="player.previous()"
                                    disabled><i class="fas fa-backward"></i></button>
                                <button class="btn btn-default" id="playPauseButton" onclick="player.togglePlay()"
                                    disabled><i class="fas fa-play"></i></button>
                                <button class="btn btn-default" id="nextTrackButton" onclick="player.next()" disabled><i
                                        class="fas fa-forward"></i></button>

                                <input type="range" id="playingProgress" class="custom-range w-75" value="0">

                            </div>
                            <div class="col-4">
                                <input type="range" min="0" max="100" class="slider" id="volumeSlider" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div id="playlistsDiv" class="btn-group btn-group-toggle" data-toggle="buttons"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="v-pills-playist" role="tabpanel" aria-labelledby="v-pills-playist-tab">
                    <div class="container">
                        <div class="row">
                            <div class="col">
                                <h2>Playlists</h2>
                            </div>
                            <div class="col">
                                <h2>Songs in Playist</h2>
                            </div>
                            <div class="col">
                                <div class="row">
                                    <h2>Songs In Library</h2>
                                </div>
                                <div class="row">
                                    more
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="v-pills-samplers" role="tabpanel" aria-labelledby="v-pills-samplers-tab">
                    <div class="container">
                        <div class="row">
                            <div class="col-3">
                                <h2>Library</h2>
                                <div class="form-group">
                                    <label for="searchInput">Search</label>
                                    <input class="form-control" id="searchInput">
                                </div>
                            </div>
                            <div class="col-9">Samplers</div>
                        </div>
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <ul class="list-group" id="filteredTracksList">

                                    </ul>
                                </div>
                            </div>

                            <div class="col-9">
                                <div class="container" id="samplerTargets"></div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>



    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
        integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
        crossorigin="anonymous"></script>
    <script src="scripts/playlist_manager/playlistManager.js"></script>
    <script>
        function initSamplerPage() {

            $.get("http://127.0.0.1:3000/library", "", (tracks) => {

                var searchElem = document.getElementById('searchInput');
                var listElem = document.getElementById('filteredTracksList');
                searchElem.oninput = function () {
                    while (listElem.firstChild) {
                        listElem.removeChild(listElem.firstChild);
                    }
                    var searchValue = searchElem.value;
                    var filtered = tracks.filter((track) => track.trackName.includes(searchValue)).slice(0, 15).map((track) => {
                        var listItemElement = document.createElement('li');
                        listItemElement.classList.add('list-group-item');
                        listItemElement.innerText = track.trackName;
                        listItemElement.ondragstart = dragtest;
                        listItemElement.draggable = true;
                        listItemElement.src = track.trackFile;
                        listElem.appendChild(listItemElement);
                    })


                };

            });

            function dragtest(ev) {
                ev.dataTransfer.setData("text", ev.target.innerText);
                ev.dataTransfer.setData("src", ev.target.src);
            }

            function allowDrop(ev) {
                ev.preventDefault();
            }

            function dropTrack(ev) {
                ev.preventDefault();
                var data = ev.dataTransfer.getData("text");
                ev.target.innerText=data;
                ev.target.src= ev.dataTransfer.getData("src");
            }

            var samplerContainer = document.getElementById('samplerTargets');

            for (row = 0; row < 8; row++) {
                var rowElement = document.createElement('DIV');
                rowElement.classList.add('row');
                for (col = 0; col < 4; col++) {
                    var colElement = document.createElement('DIV');
                    colElement.classList.add('col');

                    var button = document.createElement('BUTTON');
                    button.classList.add('btn');
                    button.classList.add('btn-default');
                    button.innerText = '___';
                    button.ondrop = dropTrack;
                    button.ondragover = allowDrop;
                    button.onclick= function(){
                        if(this.src){
                            var audio = new Audio();
                            audio.src = this.src;
                            audio.play();
                        }
                    }
                    colElement.appendChild(button);
                    rowElement.appendChild(colElement);
                }
                samplerContainer.appendChild(rowElement);
            }

        }
        initSamplerPage();

        NLM.init();


        var player = new PlaylistPlayer();
        player.progressUpdate = function (percentage) {
            var progressElement = document.getElementById('playingProgress');
            progressElement.value = percentage * 100;
        }
        var midiPlayKey = PlayKey(() => {
            player.togglePlay();
        });

        NLM.setupBtn(0, 0, 8, CallbackKey('hi_green', 'lo_amber', () => player.previous()));
        NLM.setupBtn(0, 1, 8, midiPlayKey);
        NLM.setupBtn(0, 2, 8, CallbackKey('hi_green', 'lo_amber', () => player.next()));


        player.onPlay = function () {
            var element = document.getElementById("playPauseButton");
            element.innerHTML = '<i class="fas fa-pause"></i>';
            element.disabled = false;
            midiPlayKey.playing = true;
            midiPlayKey.setled();
            document.getElementById('prevTrackButton').disabled = false;
            document.getElementById('nextTrackButton').disabled = false;
        }

        player.onPause = function () {
            var element = document.getElementById("playPauseButton");
            element.innerHTML = '<i class="fas fa-play"></i>';
            element.disabled = false;

            midiPlayKey.playing = false;
            midiPlayKey.setled();
        }

        var volumeSlider = document.getElementById("volumeSlider");
        volumeSlider.oninput = function () {
            player.setVolume(this.value / 100);
        }
        document.getElementById("playingProgress").oninput = function () {
            player.setPosition(this.value / 100);
        }



        var playlistKeys = new Array();
        var labelElems = new Array();
        function processPlaylists(playlists) {
            playlists.forEach((element, index) => {
                function loadPlaylist(listnum) {
                    document.getElementById('currentPlaylistLabel').textContent = playlists[listnum].name;
                    player.setPlaylist(playlists[listnum]);
                    playlistKeys.forEach((e) => {
                        e.setValue(listnum);
                    });
                    labelElems.forEach((e) => {
                        if (e.playlistId === listnum) {
                            e.classList.add("active");
                        } else {
                            e.classList.remove("active");
                        }
                    })

                }

                var label = document.createElement("LABEL");
                label.classList.add("btn");
                label.classList.add("btn-secondary");
                label.playlistId = index;
                label.innerHTML = element.name;
                var btn = document.createElement("INPUT");       // Create a <button> element
                btn.type = "radio";
                btn.name = "playlists";
                label.onclick = () => loadPlaylist(index);

                labelElems.push(label);
                label.appendChild(btn);

                var tempKey = GroupKey("playlists", index);
                tempKey.onPushCallback = function (index) {
                    if (this.pos == index && this.active) {
                        player.togglePlay();
                    } else {
                        loadPlaylist(index)
                    }
                }.bind(tempKey);
                NLM.setupBtn(0, 0, index, tempKey);
                playlistKeys.push(tempKey);

                document.getElementById('playlistsDiv').appendChild(label);

            });

        }



        $.get("http://127.0.0.1:3000/playlists", "", processPlaylists);

        var volumeKeys = new Array();
        // Volume Control
        for (i = 0; i < 8; i++) {
            var tempKey = SliderKey(0, i);
            tempKey.onPushCallback = function (value) {
                player.setVolume(value);
            };
            NLM.setupBtn(0, 3, 7 - i, tempKey);
            volumeKeys.push(tempKey);
        }

        player.onVolumeChange = function (targetVolume) {
            volumeSlider.value = targetVolume * 100;
            volumeKeys.forEach((e) => {
                e.setValue(targetVolume);
            })
        }

        player.setVolume(1);

        function midiInit(midi) {
            var inputs = midi.inputs.values();
            for (var input = inputs.next();
                input && !input.done;
                input = inputs.next()) {
                if (input.value.name.startsWith('Launchpad Mini')) {
                    // each time there is a midi message call the onMIDIMessage function
                    input.value.onmidimessage = NLM.incomingData;
                    break;
                }
            }

            var outputs = midi.outputs.values();
            for (var output = outputs.next();
                output && !output.done;
                output = outputs.next()) {
                if (output.value.name.startsWith('Launchpad Mini')) {
                    // each time there is a midi message call the onMIDIMessage function
                    console.log('Found output midi');
                    NLM.sendToDevice = function (data) {
                        output.value.send(data);
                    }
                    NLM.drawPage();
                    break;
                }
            }

        }
        function midiFailure() {
            console.log('Error initializing MIDI');
        }

        if (navigator.requestMIDIAccess) {
            console.log('Browser supports MIDI!');
            navigator.requestMIDIAccess().then(
                midiInit, midiFailure
            );
        }

    </script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->


</body>

</html>